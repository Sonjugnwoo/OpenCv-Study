#include "ImagePreprocessor.h"
// ====================================================================================
// 불량 검사 전용 3단계 전처리 파이프라인
// ====================================================================================
cv::Mat ImagePreprocessor::preprocessor_image(const cv::Mat& input) {
	cv::Mat result;
	// ════════════════════════════════════════════
	// cv::GaussianBlur() - 가우시안 블러링
	// ════════════════════════════════════════════
	// 기능: 이미지 전체를 **부드럽게 흐리게** 만듦 (노이즈 제거)
	// 원본 컬러, 출력 이미지, 커널 크기, 수평 시그마 , 세로 시그마 
	cv::GaussianBlur(input, result, cv::Size(7, 7), 1.5, 3.0);	// 결함과 배경 분리

	// ════════════════════════════════════════════
	// cv::cvtColor() - 컬러 → 그레이스케일 변환
	// ════════════════════════════════════════════
	// 기능: **3채널 컬러(BGR)** → **1채널 밝기(GRAY)** 변환
	cv::Mat gray;
	// 블러링된 컬러 이미지, 출력 그레이스케일(0~255), 표준 변환 공식
	cv::cvtColor(result, gray, cv::COLOR_BGR2GRAY);	// 결함 검출에 집중

	// ════════════════════════════════════════════
	// cv::createCLAHE() - 적응형 히스토그램 평활화 생성
	// ════════════════════════════════════════════
	// 기능: **CLAHE 객체 생성** (Contrast Limited AHE)
	// 증폭 상한, 256개 타일로 이미지 분할
	cv::Ptr<cv::CLAHE> clahe = cv::createCLAHE(1.5, cv::Size(16, 16));	// 과도한 강조 방지 및 전체 균형

	// ════════════════════════════════════════════
	// clahe->apply() - 로컬 대비 향상 적용
	// ════════════════════════════════════════════
	// 기능: **각 64x64 영역별로 히스토그램 평활화**
	clahe->apply(gray, gray);	// 결함 로컬 대비 극대화

	// ════════════════════════════════════════════
	// cv::morphologyEx() - 형태학 OPEN 연산
	// ════════════════════════════════════════════
	// 기능: **침식(EROSION) + 팽창(DILATION)** 연속 적용
	// CLAHE 처리 이미지, 최종출력, 작은 노이즈 제거, 타원형 구조 요소
	cv::morphologyEx(gray, result, cv::MORPH_OPEN, cv::Mat());	// 대형 결함 남김

	return result;
}